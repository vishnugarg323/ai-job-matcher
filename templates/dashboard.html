<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Matcher - Multi-Profile Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 1400px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .profile-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .profile-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .job-row {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .job-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .match-badge {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .status-running {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-briefcase-fill"></i> AI Job Matcher
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="bi bi-clock"></i> <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid dashboard-container">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Active Profiles</h6>
                            <h2 class="mb-0" id="stat-profiles">0</h2>
                        </div>
                        <i class="bi bi-people-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Jobs (7 Days)</h6>
                            <h2 class="mb-0" id="stat-jobs">0</h2>
                        </div>
                        <i class="bi bi-briefcase-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Success Rate</h6>
                            <h2 class="mb-0"><span id="stat-success">0</span>%</h2>
                        </div>
                        <i class="bi bi-check-circle-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Avg Jobs/Run</h6>
                            <h2 class="mb-0" id="stat-avg">0</h2>
                        </div>
                        <i class="bi bi-graph-up-arrow" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Profiles Sidebar -->
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-person-circle"></i> Profiles</h5>
                        <button class="btn btn-sm btn-gradient" onclick="showAddProfileModal()">
                            <i class="bi bi-plus-lg"></i> Add Profile
                        </button>
                    </div>
                    <div class="card-body" id="profiles-list" style="max-height: 600px; overflow-y: auto;">
                        <!-- Profiles will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-8">
                <!-- Welcome message (shown when no profile selected) -->
                <div id="welcome-message" class="card bg-dark">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-rocket-takeoff" style="font-size: 5rem; color: #667eea;"></i>
                        <h3 class="mt-3">Welcome to AI Job Matcher!</h3>
                        <p class="text-muted">Select a profile or create a new one to get started.</p>
                        <button class="btn btn-gradient btn-lg" onclick="showAddProfileModal()">
                            <i class="bi bi-plus-lg"></i> Create Your First Profile
                        </button>
                    </div>
                </div>

                <!-- Profile Details (shown when profile selected) -->
                <div id="profile-details" style="display: none;">
                    <!-- Jobs Found -->
                    <div class="card bg-dark mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> Recent Jobs</h5>
                            <span class="badge bg-primary" id="jobs-count">0 jobs</span>
                        </div>
                        <div class="card-body" id="jobs-list" style="max-height: 400px; overflow-y: auto;">
                            <!-- Jobs will be loaded here -->
                        </div>
                    </div>

                    <!-- Run History -->
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Run History</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Jobs Found</th>
                                            <th>Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table">
                                        <!-- History will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalTitle">
                        <i class="bi bi-person-plus-fill"></i> Add Profile
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <input type="hidden" id="profile-id">
                        
                        <!-- Basic Info -->
                        <div class="mb-3">
                            <label class="form-label">Profile Name *</label>
                            <input type="text" class="form-control" id="profile-name" required 
                                   placeholder="e.g., Software Engineer Search">
                            <small class="text-muted">A name to identify this job search</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="profile-email" required
                                   placeholder="your.email@gmail.com">
                            <small class="text-muted">Job matches will be sent to this email</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Job Title *</label>
                            <input type="text" class="form-control" id="profile-job-title" required
                                   placeholder="e.g., Software Engineer, Python Developer">
                            <small class="text-muted">What job are you looking for?</small>
                        </div>

                        <!-- Resume Upload -->
                        <div class="mb-3">
                            <label class="form-label">Resume (PDF only) *</label>
                            <input type="file" class="form-control" id="profile-resume" accept=".pdf" required>
                            <small class="text-muted">Upload your resume in PDF format</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-gradient" onclick="saveProfile()">
                        <i class="bi bi-save"></i> Save Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let selectedProfileId = null;
        let profileModal;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
            loadDashboardStats();
            loadProfiles();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(loadDashboardStats, 30000); // Refresh every 30s
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-profiles').textContent = data.stats.total_profiles;
                    document.getElementById('stat-jobs').textContent = data.stats.jobs_last_7_days;
                    document.getElementById('stat-success').textContent = data.stats.success_rate;
                    document.getElementById('stat-avg').textContent = data.stats.avg_jobs_per_run;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const data = await response.json();
                
                if (data.success) {
                    const profilesList = document.getElementById('profiles-list');
                    
                    if (data.profiles.length === 0) {
                        profilesList.innerHTML = '<p class="text-muted text-center">No profiles yet. Create one to get started!</p>';
                        return;
                    }
                    
                    profilesList.innerHTML = data.profiles.map(profile => `
                        <div class="profile-card ${selectedProfileId === profile.id ? 'border-primary' : ''}" 
                             onclick="selectProfile(${profile.id})">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <i class="bi bi-person-badge"></i> ${profile.name}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="bi bi-envelope"></i> ${profile.email}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-file-earmark-pdf"></i> 
                                        ${profile.resume_path ? 'Resume uploaded' : 'No resume'}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); triggerRun(${profile.id})" title="Run Now">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editProfile(${profile.id})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteProfile(${profile.id})" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        function selectProfile(profileId) {
            selectedProfileId = profileId;
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('profile-details').style.display = 'block';
            loadProfiles(); // Reload to update selection
            loadProfileJobs(profileId);
            loadProfileHistory(profileId);
        }

        async function loadProfileJobs(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}/jobs?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('jobs-count').textContent = `${data.count} jobs`;
                    const jobsList = document.getElementById('jobs-list');
                    
                    if (data.jobs.length === 0) {
                        jobsList.innerHTML = '<p class="text-muted text-center">No jobs found yet. Trigger a manual run!</p>';
                        return;
                    }
                    
                    jobsList.innerHTML = data.jobs.map(job => `
                        <div class="job-row">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${job.title}</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-building"></i> ${job.company} | 
                                        <i class="bi bi-geo-alt"></i> ${job.location || 'Not specified'}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${new Date(job.created_at).toLocaleDateString()}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="match-badge ${getMatchColor(job.match_score)}">
                                        ${(job.match_score * 100).toFixed(0)}%
                                    </span>
                                    <br>
                                    <a href="${job.url}" target="_blank" class="btn btn-sm btn-gradient mt-2">
                                        <i class="bi bi-box-arrow-up-right"></i> Apply
                                    </a>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function loadProfileHistory(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}/history?limit=10`);
                const data = await response.json();
                
                if (data.success) {
                    const historyTable = document.getElementById('history-table');
                    
                    if (data.history.length === 0) {
                        historyTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No run history yet</td></tr>';
                        return;
                    }
                    
                    historyTable.innerHTML = data.history.map(run => {
                        const started = new Date(run.started_at);
                        const completed = run.completed_at ? new Date(run.completed_at) : null;
                        const duration = completed ? Math.round((completed - started) / 1000) : '...';
                        
                        return `
                            <tr>
                                <td>${started.toLocaleString()}</td>
                                <td><span class="badge ${getStatusBadge(run.status)}">${run.status}</span></td>
                                <td>${run.jobs_found || 0}</td>
                                <td>${duration}s</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function getMatchColor(score) {
            if (score >= 0.95) return 'badge bg-success';
            if (score >= 0.90) return 'badge bg-primary';
            if (score >= 0.85) return 'badge bg-warning';
            return 'badge bg-secondary';
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'success': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'running': return 'bg-primary status-running';
                default: return 'bg-secondary';
            }
        }

        function showAddProfileModal() {
            document.getElementById('profileModalTitle').innerHTML = '<i class="bi bi-person-plus-fill"></i> Add Profile';
            document.getElementById('profileForm').reset();
            document.getElementById('profile-id').value = '';
            profileModal.show();
        }

        async function saveProfile() {
            const profileId = document.getElementById('profile-id').value;
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;
            const jobTitle = document.getElementById('profile-job-title').value;
            
            if (!name || !email || !jobTitle) {
                alert('Please fill in all required fields');
                return;
            }

            // Build simple job preferences with just the job title
            const jobPreferences = {
                job_titles: [jobTitle],
                locations: ["Berlin", "Munich", "Hamburg", "Frankfurt", "Cologne", "Remote"]
            };

            try {
                let response;
                if (profileId) {
                    // Update existing profile
                    response = await fetch(`/api/profiles/${profileId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, email, job_preferences: jobPreferences})
                    });
                } else {
                    // Create new profile
                    response = await fetch('/api/profiles', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, email, job_preferences: jobPreferences})
                    });
                    });
                }

                const data = await response.json();
                
                if (data.success) {
                    const newProfileId = profileId || data.profile_id;
                    
                    // Upload resume if provided
                    const resumeFile = document.getElementById('profile-resume').files[0];
                    if (resumeFile) {
                        const formData = new FormData();
                        formData.append('resume', resumeFile);
                        
                        await fetch(`/api/profiles/${newProfileId}/resume`, {
                            method: 'POST',
                            body: formData
                        });
                    }
                    
                    profileModal.hide();
                    loadProfiles();
                    alert('Profile saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile');
            }
        }

        async function triggerRun(profileId) {
            if (!confirm('Start job search for this profile?')) return;
            
            try {
                const response = await fetch(`/api/profiles/${profileId}/run`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Job search started! Check history in a few minutes.');
                    setTimeout(() => {
                        if (selectedProfileId === profileId) {
                            loadProfileHistory(profileId);
                        }
                    }, 5000);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error triggering run:', error);
                alert('Error starting job search');
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Delete this profile? All jobs and history will be removed.')) return;
            
            try {
                const response = await fetch(`/api/profiles/${profileId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    if (selectedProfileId === profileId) {
                        selectedProfileId = null;
                        document.getElementById('welcome-message').style.display = 'block';
                        document.getElementById('profile-details').style.display = 'none';
                    }
                    loadProfiles();
                    loadDashboardStats();
                    alert('Profile deleted');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting profile:', error);
                alert('Error deleting profile');
            }
        }
    </script>
</body>
</html>
